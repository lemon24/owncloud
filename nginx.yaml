
- name: install nginx
  package:
    name: nginx
    state: latest

- name: remove nginx default site
  file:
    state: absent
    path: "/etc/nginx/sites-enabled/default"

- name: create cert dirs
  file:
    path: "{{ item }}"
    state: directory
    owner: root
  with_items:
    - /etc/nginx/certs/
    - /etc/nginx/certs/server
    - /etc/nginx/certs/ca

# TODO: permissions
- name: copy certs
  copy:
    src: "{{ item }}"
    dest: "/etc/nginx/certs/{{ item | relpath(outdir) }}"
    owner: root
  with_items:
    - "{{ outdir }}/server/{{ domain }}.crt"
    - "{{ outdir }}/server/{{ domain }}.key"
    - "{{ outdir }}/ca/ca.crt"
   
- name: copy server config
  template:
    src: secure.conf
    dest: /etc/nginx/sites-available/secure.conf

- name: enable server config
  file:
    path: /etc/nginx/sites-enabled/secure.conf
    src: /etc/nginx/sites-available/secure.conf
    state: link
   
- name: reload server config
  command: nginx -s reload
 


# TODO: in different playbook: set up /dev/x

 #48  sudo mkfs -t ext4 /dev/xvdb
 #50  sudo mkdir /data
 #51  sudo mount /dev/xvdb /data
 #54  sudo cp /etc/fstab /etc/fstab.orig
 #59  sudo vim /etc/fstab
 #60  sudo reboot

#$ cat /etc/fstab
#LABEL=cloudimg-rootfs	/	 ext4	defaults,discard	0 0
#/dev/xvdb		/data	 ext4 	defaults,nofail		0 2


